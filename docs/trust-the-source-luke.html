<!DOCTYPE html>
<html lang="en">

<head>
    <title>Marcin Panasiuk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style type="text/css">
        html,
        body,
        p,
        div,
        img,
        h1,
        h2,
        h3,
        h4,
        ol,
        dl,
        dd,
        dt,
        form,
        table,
        td,
        tr {
            margin: 0;
            padding: 0;
            border: 0;
            border-collapse: separate;
            border-spacing: 0;
        }

        h1 {
            text-align: center;
            font-weight: bold;
        }

        html {
            background-color: hsl(210, 25%, 8%);
            color: #c5c5c5;
            /* font-family: 'Lato', sans-serif; */
            /* font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif; */
            /* font-family: "Open Sans", sans-serif; */
            font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            padding-top: 1em;
            padding-bottom: 1em;
        }

        p {
            margin-bottom: 1em;
        }

        ul li p {
            margin-bottom: 0;
        }

        div {
            padding: 0;
            margin: 0;
        }

        body {
            font-size: 100%;
        }

        a {
            color: rgb(0, 150, 207);
            ;
        }

        a:hover {
            text-decoration: none;
        }

        div#logo {
            width: 100%;
            text-align: center;
            font-size: 150%;
        }

        div#logo a {
            text-decoration: none;
            color: rgb(115, 116, 128);
        }

        div#content {
            width: 100%;
        }

        div#content div#innercontent {
            max-width: 80ch;
            margin: auto;
            padding-left: 5%;
            padding-right: 5%;
        }

        header,
        footer {
            font-size: 75%;
            text-align: center;
            color: rgb(115, 116, 128);
        }

        header>a,
        footer>a {
            color: rgb(115, 116, 128);
        }

        hr.before-footer {
            margin-top: 2em;
            border-color: rgb(115, 116, 128);
        }

        header {
            margin-bottom: 2em;
        }

        nav {
            width: 100%;
            text-align: center;
            font-size: 105%;
            padding-bottom: 2%;
            color: rgb(115, 116, 128);
        }

        nav>a {
            color: rgb(115, 116, 128);
            /* color: rgb(250, 150, 84); */
            text-decoration: none;
        }

        a.active {
            color: #c5c5c5;
            /* color: rgb(255, 180, 84); */
        }

        pre {
            overflow: auto;
            padding-top: 0.5em;
            padding-bottom: 0.5em;
            padding-left: 1em;
        }

        ol {
            margin-left: 2em;
        }

        img.align-center {
            margin: 1em auto;
            display: block;
        }

        img {
            width: 80%;
            height: auto;
            border-radius: 5%;
        }

        @media only screen and (min-width: 800px) {
            img {
                width: 60%;
            }
        }

        .literal-block {
            background-color: rgb(25, 31, 38);
            color: rgb(230, 226, 207);
            font-family: "Source Code Pro", Consolas, "Ubuntu Mono", Menlo, "DejaVu Sans Mono", monospace, monospace;
            font-size: 14px;
            border-radius: 10px;
        }

        tt {
            background-color: #191f26;
            color: rgb(255, 180, 84);
            font-family: "Source Code Pro", Consolas, "Ubuntu Mono", Menlo, "DejaVu Sans Mono", monospace, monospace;
            font-size: 0.875em;
            overflow-x: initial;
            display: inline;
            padding: 0.1em 0.3em;
            border-radius: 6px;
            line-height: 1.45em;
            padding-top: 3pt;
            padding-bottom: 3pt;
        }

        pre {
            font-family: "Source Code Pro", Consolas, "Ubuntu Mono", Menlo, "DejaVu Sans Mono", monospace, monospace;
            font-size: 14px;
            border-radius: 10px;

            display: block;
            overflow-x: auto;
        }
    </style>

    <link rel="stylesheet" href="/theme/highlight.css" type="text/css">

    <link href="https://marcinpanasiuk.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
        title="Marcin Panasiuk Full Atom Feed" />
</head>

<body>
    <div id="logo">
        <a href="/">Marcin Panasiuk</a>
    </div>
    <nav>
        <a  class="active"  href="/">Posts</a>
        |
        <a  href="/tags.html">Tags</a>
        |
        <a  href="/pages/projects.html">Projects</a>
        |
        <a  href="/pages/contact.html">Contact</a>
        |
        <a href="/feeds/all.atom.xml">Atom</a>
    </nav>
    <div id="content">
        <div id="innercontent">
<h1>Trust the Source, Luke</h1>
<header>
  Published on <time datetime="2023-11-24T19:30:00+01:00">2023-11-24</time>.
    Tagged with
      <a href="/tag/c.html">c++</a>,      <a href="/tag/security.html">security</a>.
</header>

<img alt="Yoda" class="align-center" src="/images/yoda.jpg" />
<p>It is a common belief that the only documentation a programmer should rely on is the source code. Some experienced engineers argue that one should only trust in the disassembly. However, I'd like to present a case where neither of these beliefs holds true.</p>
<p>Consider this kernel code:</p>
<div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">kernel_func</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">public_bounds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">detector</span><span class="p">[</span><span class="n">secret</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SOME_BIG_NUMBER</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nf">void</span><span class="w"> </span><span class="nv">kernel_func</span><span class="p">(</span><span class="nv">int</span><span class="p">)</span><span class="w"> </span><span class="nv">PROC</span><span class="w"></span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="nb">ebp</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="nb">ebp</span><span class="p">,</span><span class="w"> </span><span class="nb">esp</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="nb">eax</span><span class="p">,</span><span class="w"> </span><span class="kt">DWORD</span><span class="w"> </span><span class="nv">PTR</span><span class="w"> </span><span class="nv">_index$</span><span class="p">[</span><span class="nb">ebp</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">cmp</span><span class="w">     </span><span class="nb">eax</span><span class="p">,</span><span class="w"> </span><span class="kt">DWORD</span><span class="w"> </span><span class="nv">PTR</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">public_bounds</span><span class="w"></span>
<span class="w">    </span><span class="nf">jge</span><span class="w">     </span><span class="nv">SHORT</span><span class="w"> </span><span class="kc">$</span><span class="nv">LN1@kernel_fun</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="nb">ecx</span><span class="p">,</span><span class="w"> </span><span class="kt">DWORD</span><span class="w"> </span><span class="nv">PTR</span><span class="w"> </span><span class="nv">_index$</span><span class="p">[</span><span class="nb">ebp</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="nb">edx</span><span class="p">,</span><span class="w"> </span><span class="kt">DWORD</span><span class="w"> </span><span class="nv">PTR</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">secret</span><span class="p">[</span><span class="nb">ecx</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">imul</span><span class="w">    </span><span class="nb">edx</span><span class="p">,</span><span class="w"> </span><span class="kt">DWORD</span><span class="w"> </span><span class="nv">PTR</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">SOME_BIG_NUMBER</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="nb">eax</span><span class="p">,</span><span class="w"> </span><span class="kt">DWORD</span><span class="w"> </span><span class="nv">PTR</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">x</span><span class="w"></span>
<span class="w">    </span><span class="nf">xor</span><span class="w">     </span><span class="nb">eax</span><span class="p">,</span><span class="w"> </span><span class="kt">DWORD</span><span class="w"> </span><span class="nv">PTR</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">detector</span><span class="p">[</span><span class="nb">edx</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="kt">DWORD</span><span class="w"> </span><span class="nv">PTR</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nb">eax</span><span class="w"></span>
<span class="nl">$LN1@kernel_fun:</span><span class="w"></span>
<span class="w">    </span><span class="nf">pop</span><span class="w">     </span><span class="nb">ebp</span><span class="w"></span>
<span class="w">    </span><span class="nf">ret</span><span class="w">     </span><span class="mi">0</span><span class="w"></span>
</pre></div>
<p>Could we obtain the value of the <code>secret[index]</code> for indices outside of <code>public_bounds</code>, if we have only access to <code>index</code>, <code>detector[]</code> and the value of <code>SOME_BIG_NUMBER</code>? According to the source code and disassembly we should not, right?</p>
<p>Right?</p>
<p>Welcome to hardware land! CPU hates idleness. If there is a cache miss in the branch condition <code>index &lt; public_bounds</code>, which would make CPU stall for a while, CPU can calculate <code>x = x ^ detector[secret[index] * ...]</code> doing <a class="reference external" href="https://en.wikipedia.org/wiki/Speculative_execution">speculative execution</a>. If the condition, fetched from memory, turns out to be false, the CPU simply doesn't commit the speculative result. So, what's the issue? The problem arises because the CPU can fetch <code>detector[secret[index] * ...]</code> into cache, even if the branch condition is <strong>not</strong> met!</p>
<p>So, in the user process, we could've evicted whole cache, executed <code>kernel_func</code> making CPU do branch prediction (by running it with a valid <code>index</code> a few times beforehand), and then executed:</p>
<div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__rdtsc</span><span class="p">();</span><span class="w">  </span><span class="c1">// high-precision timer</span>
<span class="k">auto</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detector</span><span class="p">[</span><span class="sc">&#39;A&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SOME_BIG_NUMBER</span><span class="p">];</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__rdtsc</span><span class="p">();</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"></span>
</pre></div>
<p>In this manner, we could have determined if <code>secret[index]</code> was 'A' simply by measuring the time difference (a small time indicates it was fetched into the cache by <em>speculative execution</em>). We could repeat the entire process for 'B', 'C', 'D', etc., and voilà!</p>
<p>This vulnerability, called <a class="reference external" href="https://meltdownattack.com">Spectre/Meltdown</a>, has been described in more detail in <a class="reference external" href="https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html">&quot;Reading privilaged memory with a side-channel&quot;</a> by Jann Horn.</p>
<p>Be careful where you place your trust.</p>


            <hr class="before-footer">
            <footer>
                Generated from <a href="https://github.com/panmar/panmar.github.io/commit/a7b92ee">commit a7b92ee</a> on <nobr>2024-02-17 14:09:45+01:00</nobr>.
                Content licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.
            </footer>
        </div>
    </div>
</body>

</html>