<!DOCTYPE html>
<html lang="en">

<head>
    <title>Marcin Panasiuk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style type="text/css">
        html,
        body,
        p,
        div,
        img,
        h1,
        h2,
        h3,
        h4,
        ol,
        dl,
        dd,
        dt,
        form,
        table,
        td,
        tr {
            margin: 0;
            padding: 0;
            border: 0;
            border-collapse: separate;
            border-spacing: 0;
        }

        h1 {
            text-align: center;
            font-weight: bold;
        }

        html {
            background-color: hsl(210, 25%, 8%);
            color: #c5c5c5;
            /* font-family: 'Lato', sans-serif; */
            /* font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif; */
            /* font-family: "Open Sans", sans-serif; */
            font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            padding-top: 1em;
            padding-bottom: 1em;
        }

        p {
            margin-bottom: 1em;
        }

        ul li p {
            margin-bottom: 0;
        }

        div {
            padding: 0;
            margin: 0;
        }

        body {
            font-size: 100%;
        }

        a {
            color: rgb(0, 150, 207);
            ;
        }

        a:hover {
            text-decoration: none;
        }

        div#logo {
            width: 100%;
            text-align: center;
            font-size: 150%;
        }

        div#logo a {
            text-decoration: none;
            color: rgb(115, 116, 128);
        }

        div#content {
            width: 100%;
        }

        div#content div#innercontent {
            max-width: 80ch;
            margin: auto;
            padding-left: 5%;
            padding-right: 5%;
        }

        header,
        footer {
            font-size: 75%;
            text-align: center;
            color: rgb(115, 116, 128);
        }

        header>a,
        footer>a {
            color: rgb(115, 116, 128);
        }

        hr.before-footer {
            margin-top: 2em;
            border-color: rgb(115, 116, 128);
        }

        header {
            margin-bottom: 2em;
        }

        nav {
            width: 100%;
            text-align: center;
            font-size: 105%;
            padding-bottom: 2%;
            color: rgb(115, 116, 128);
        }

        nav>a {
            color: rgb(115, 116, 128);
            /* color: rgb(250, 150, 84); */
            text-decoration: none;
        }

        a.active {
            color: #c5c5c5;
            /* color: rgb(255, 180, 84); */
        }

        pre {
            overflow: auto;
            padding-top: 0.5em;
            padding-bottom: 0.5em;
            padding-left: 1em;
        }

        ol {
            margin-left: 2em;
        }

        img.align-center {
            margin: 1em auto;
            display: block;
        }

        img {
            width: 80%;
            height: auto;
            border-radius: 5%;
        }

        @media only screen and (min-width: 800px) {
            img {
                width: 60%;
            }
        }

        .literal-block {
            background-color: rgb(25, 31, 38);
            color: rgb(230, 226, 207);
            font-family: "Source Code Pro", Consolas, "Ubuntu Mono", Menlo, "DejaVu Sans Mono", monospace, monospace;
            font-size: 14px;
            border-radius: 10px;
        }

        tt {
            background-color: #191f26;
            color: rgb(255, 180, 84);
            font-family: "Source Code Pro", Consolas, "Ubuntu Mono", Menlo, "DejaVu Sans Mono", monospace, monospace;
            font-size: 0.875em;
            overflow-x: initial;
            display: inline;
            padding: 0.1em 0.3em;
            border-radius: 6px;
            line-height: 1.45em;
            padding-top: 3pt;
            padding-bottom: 3pt;
        }

        pre {
            font-family: "Source Code Pro", Consolas, "Ubuntu Mono", Menlo, "DejaVu Sans Mono", monospace, monospace;
            font-size: 14px;
            border-radius: 10px;

            display: block;
            overflow-x: auto;
        }
    </style>

    <link rel="stylesheet" href="/theme/highlight.css" type="text/css">

    <link href="https://marcinpanasiuk.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
        title="Marcin Panasiuk Full Atom Feed" />
</head>

<body>
    <div id="logo">
        <a href="/">Marcin Panasiuk</a>
    </div>
    <nav>
        <a  class="active"  href="/">Posts</a>
        |
        <a  href="/tags.html">Tags</a>
        |
        <a  href="/pages/projects.html">Projects</a>
        |
        <a  href="/pages/contact.html">Contact</a>
        |
        <a href="/feeds/all.atom.xml">Atom</a>
    </nav>
    <div id="content">
        <div id="innercontent">
<h1>Crazy Little Thing Called Float</h1>
<header>
  Published on <time datetime="2023-11-20T11:28:00+01:00">2023-11-20</time>.
    Tagged with
      <a href="/tag/c.html">c++</a>.
</header>

<p>What's wrong with this C++ code?</p>
<div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">16777217.f</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">16777218.f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">f</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.f</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>It will run forever.</p>
<p>It is pretty common knowledge that the best way to get broke is to use <a class="reference external" href="https://en.wikipedia.org/wiki/Single-precision_floating-point_format">floats</a> to store money. Clearly, not all rational numbers can be represented as floating-point numbers:</p>
<div class="highlight"><pre><span></span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%1.10f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.7f</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0.6999999881</span>
</pre></div>
<p>A little less known fact is that floats distribution is not uniform. The farther away from 0.0 the larger <strong>gaps</strong> without any representation.</p>
<p>Lets look at the numbers from the first code sample:</p>
<div class="highlight"><pre><span></span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%20.16f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">16777217.f</span><span class="p">);</span><span class="w"> </span><span class="c1">// 16777216.0000000000000000</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%20.16f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">16777218.f</span><span class="p">);</span><span class="w"> </span><span class="c1">// 16777218.0000000000000000</span>
</pre></div>
<p>Now we can see that between <strong>16,777,216</strong> and <strong>16,777,218</strong> there is a pretty large gap.
If you kept tracking your dollars as floats around 16M there would be gaps as big as 2$.</p>
<p>How fast will those gaps grow? At around <strong>140,000,000</strong> we can find gaps of size 16. At around <strong>1,000,000, 000</strong> of size 64.</p>
<p>To see how floating-point numbers are stored internally, you can play with this nice tool <a class="reference external" href="https://float.exposed/0x4b800001">here</a>.</p>


            <hr class="before-footer">
            <footer>
                Generated from <a href="https://github.com/panmar/panmar.github.io/commit/a7b92ee">commit a7b92ee</a> on <nobr>2024-02-17 14:09:45+01:00</nobr>.
                Content licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.
            </footer>
        </div>
    </div>
</body>

</html>